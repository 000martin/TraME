#!/bin/bash
## TraME config script

while getopts b: option
do
 case "${option}"
 in
 b) TRAME_DEV=${OPTARG};;
 esac
done

if [ -z ${CC+x} ]; then 
    CC=gcc
fi
if [ -z ${CXX+x} ]; then 
    CXX=g++
fi
if [ -z ${FC+x} ]; then 
    FC=gfortran
fi

if [[ !(-z ${KEITH_DEV_SETTINGS+x}) ]]; then
    CC=gcc-mp-7
    CXX=g++-mp-7
    FC=gfortran-mp-7
fi

WDIR=${PWD}

if [ -z ${ARMA_INCLUDE_PATH+x} ]; then 
    echo "TraME: ARMA_INCLUDE_PATH not set"
    if [ -f ${WDIR}/include/armadillo ]; then 
        ARMA_INCLUDE_PATH="-I./../include"
    elif [ -f /usr/include/armadillo ]; then
        ARMA_INCLUDE_PATH="-I/usr/include"
    elif [ -f /usr/local/include/armadillo ]; then
        ARMA_INCLUDE_PATH="-I/usr/local/include"
    elif [ -f /opt/include/armadillo ]; then
        ARMA_INCLUDE_PATH="-I/opt/include"
    elif [ -f /opt/local/include/armadillo ]; then
        ARMA_INCLUDE_PATH="-I/opt/local/include"
    else 
        echo "TraME tests: cannot find armadillo library."
        echo ""
        exit 1
    fi
    echo "TraME: ARMA_INCLUDE_PATH set to ${ARMA_INCLUDE_PATH}"
fi

TRAME_OPT_FLAGS="-O2"
TRAME_SHLIB_NAME="trame"

if [[ !(-z ${TRAME_DEV+x}) ]]; then
    echo "TraME: dev version"
    cd ..
    TRAME_INSTALL_PATH=${PWD}
    cd tests
else
    if [[ $OSTYPE == *linux* ]] ; then
        TRAME_INSTALL_PATH="/usr"
    else 
        TRAME_INSTALL_PATH="/usr/local"
    fi
fi

if [[ $OSTYPE == darwin* ]] ; then
        TRAME_BLAS_LAPACK="-framework Accelerate"
elif [[ $OSTYPE == *linux* ]] ; then
    TRAME_BLAS_LAPACK="-lblas -llapack"
else
    TRAME_BLAS_LAPACK="-lblas -llapack"
fi

sed -e "s|@CC@|${CC}|" \
    -e "s|@CXX@|${CXX}|" \
    -e "s|@FC@|${FC}|" \
    -e "s|@ARMA_INCLUDE_PATH@|${ARMA_INCLUDE_PATH}|" \
    -e "s|@TRAME_BLAS_LAPACK@|${TRAME_BLAS_LAPACK}|" \
    -e "s|@TRAME_OPT_FLAGS@|${TRAME_OPT_FLAGS}|" \
    -e "s|@TRAME_SHLIB_NAME@|${TRAME_SHLIB_NAME}|" \
    -e "s|@TRAME_INSTALL_PATH@|${TRAME_INSTALL_PATH}|" \
    Makefile.in > Makefile
